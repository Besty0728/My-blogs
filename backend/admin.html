<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>后台管理 - 流转星博客</title>
    <script src="/tinymce/tinymce.min.js" referrerpolicy="origin"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        @font-face {
            font-family: 'MapleMono NF CN';
            src: url('../fonts/MapleMono-NF-CN-Regular.ttf') format('truetype');
            font-weight: normal;
            font-style: normal;
            font-display: swap;
        }

        body {
            font-family: 'MapleMono NF CN', -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        /* 登录界面 */
        .login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }

        .login-box {
            background: white;
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
            width: 90%;
            max-width: 400px;
        }

        .login-box h1 {
            color: #667eea;
            margin-bottom: 30px;
            text-align: center;
        }

        input,
        textarea,
        select {
            font-family: inherit;
            width: 100%;
            padding: 12px;
            margin-bottom: 20px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
        }

        input:focus,
        textarea:focus,
        select:focus {
            outline: none;
            border-color: #667eea;
        }

        button {
            font-family: inherit;
            width: 100%;
            padding: 12px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            transition: transform 0.2s;
        }

        button:hover {
            transform: translateY(-2px);
        }

        /* 管理界面 */
        .admin-container {
            display: none;
            background: #f5f7fa;
            min-height: 100vh;
        }

        .admin-header {
            background: white;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .admin-header h1 {
            color: #667eea;
        }

        .header-buttons {
            display: flex;
            gap: 10px;
        }

        .preview-btn {
            width: auto;
            padding: 10px 20px;
            background: #4ecdc4;
        }

        .logout-btn {
            width: auto;
            padding: 10px 20px;
            background: #ff6b6b;
        }

        .admin-content {
            padding: 30px;
            max-width: 1200px;
            margin: 0 auto;
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        .tab {
            padding: 12px 24px;
            background: white;
            border: 2px solid transparent;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .tab:hover {
            border-color: #667eea;
        }

        .tab.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .section {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
            display: none;
        }

        .section.active {
            display: block;
        }

        .section h2 {
            color: #333;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #e0e0e0;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            color: #666;
            font-weight: 500;
        }

        textarea {
            min-height: 100px;
            resize: vertical;
        }

        .alert {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .item-list {
            margin-top: 30px;
        }

        .list-item {
            background: #f5f7fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .list-item:hover {
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
        }

        .item-info {
            flex: 1;
        }

        .item-info h3 {
            color: #333;
            margin-bottom: 5px;
        }

        .item-info p {
            color: #666;
            font-size: 14px;
        }

        .item-actions {
            display: flex;
            gap: 10px;
        }

        .btn-edit,
        .btn-delete {
            width: auto;
            padding: 8px 15px;
            border-radius: 6px;
            font-size: 14px;
        }

        .btn-edit {
            background: #4ecdc4;
        }

        .btn-delete {
            background: #ff6b6b;
        }

        .file-input-wrapper {
            position: relative;
            overflow: hidden;
            display: inline-block;
            width: 100%;
        }

        .file-input-wrapper input[type=file] {
            position: absolute;
            left: -9999px;
        }

        .file-input-label {
            display: block;
            padding: 12px;
            background: #f5f7fa;
            border: 2px dashed #667eea;
            border-radius: 8px;
            text-align: center;
            color: #667eea;
            cursor: pointer;
            transition: all 0.3s;
        }

        .file-input-label:hover {
            background: #e9ecef;
        }

        /* 网站和资源卡片样式 */
        .card-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .card-item {
            background: #f5f7fa;
            padding: 25px;
            border-radius: 15px;
            text-align: center;
            transition: all 0.3s;
            position: relative;
        }

        .card-item:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        }

        .card-icon {
            font-size: 48px;
            margin-bottom: 15px;
        }

        .card-item h3 {
            color: #333;
            margin-bottom: 10px;
        }

        .card-item p {
            color: #666;
            margin-bottom: 15px;
        }

        .card-actions {
            position: absolute;
            top: 10px;
            right: 10px;
        }

        .btn-delete-small {
            padding: 5px 10px;
            background: #ff6b6b;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 12px;
        }

        /* 技能标签样式 */
        .skills-container {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 20px;
        }

        .skill-tag {
            background: #e9ecef;
            padding: 10px 20px;
            border-radius: 25px;
            position: relative;
            transition: all 0.3s;
        }

        .skill-tag:hover {
            background: #667eea;
            color: white;
        }

        .skill-tag .delete-skill {
            margin-left: 10px;
            cursor: pointer;
            color: #ff6b6b;
        }

        /* 预览模态框 */
        .preview-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
        }

        .preview-content {
            width: 90%;
            height: 90%;
            margin: 5% auto;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            position: relative;
        }

        .preview-header {
            background: #333;
            color: white;
            padding: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .refresh-btn {
            background: #4ecdc4;
            color: white;
            border: none;
            padding: 8px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }

        .refresh-btn:hover {
            background: #45b7aa;
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(78, 205, 196, 0.3);
        }

        .preview-close {
            font-size: 30px;
            cursor: pointer;
        }

        .preview-iframe {
            width: 100%;
            height: calc(100% - 60px);
            border: none;
        }

        /* 响应式 */
        @media (max-width: 768px) {
            .admin-content {
                padding: 15px;
            }

            .section {
                padding: 20px;
            }

            .tabs {
                justify-content: center;
            }

            .card-grid {
                grid-template-columns: 1fr;
            }
        }

        #checkboxInput {
            display: none;
        }

        .toggleSwitch {
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            width: 50px;
            height: 30px;
            background-color: rgb(82, 82, 82);
            border-radius: 20px;
            cursor: pointer;
            transition-duration: .2s;
        }

        .toggleSwitch::after {
            content: "";
            position: absolute;
            top: 5px;
            height: 10px;
            width: 10px;
            left: 5px;
            background-color: transparent;
            border-radius: 50%;
            transition-duration: .2s;
            box-shadow: 5px 2px 7px rgba(8, 8, 8, 0.26);
            border: 5px solid white;
        }

        #checkboxInput:checked+.toggleSwitch::after {
            transform: translateX(100%);
            transition-duration: .2s;
            background-color: white;
        }

        /* Switch background change */
        #checkboxInput:checked+.toggleSwitch {
            background-color: rgb(0, 255, 55);
            transition-duration: .2s;
        }
    </style>
</head>

<body>
    <!-- 登录界面 -->
    <div class="login-container" id="loginContainer">
        <div class="login-box">
            <h1>🔐 后台管理系统</h1>
            <form id="loginForm">
                <input type="text" id="username" placeholder="用户名" value="admin" required>
                <input type="password" id="password" placeholder="密码" required>
                <button type="submit">登录</button>
            </form>
            <div class="alert alert-error" id="loginError"></div>
        </div>
    </div>

    <!-- 管理界面 -->
    <div class="admin-container" id="adminContainer">
        <header class="admin-header">
            <h1>流转星博客 - 后台管理</h1>
            <div class="header-buttons">
                <button class="preview-btn" onclick="openPreview()">预览网站</button>
                <button class="logout-btn" onclick="logout()">退出登录</button>
            </div>
        </header>

        <div class="admin-content">
            <!-- 选项卡 -->
            <div class="tabs">
                <div class="tab active" onclick="switchTab('settings')">🎵 网站设置</div>
                <div class="tab" onclick="switchTab('profile')">👤 个人信息</div>
                <div class="tab" onclick="switchTab('projects')">📝 项目管理</div>
                <div class="tab" onclick="switchTab('sites')">🏠 网站主页</div>
                <div class="tab" onclick="switchTab('resources')">🚀 资源分享</div>
                <div class="tab" onclick="switchTab('skills')">⚡ 技能管理</div>
                <div class="tab" onclick="switchTab('security')">🔒 安全设置</div>
                <div class="tab" onclick="switchTab('comments')">💬 评论管理</div>
                <div class="tab" onclick="switchTab('monitoring')">🛡️ 安全监控</div>
            </div>

            <!-- 网站设置 -->
            <div class="section active" id="settingsSection">
                <h2>🎵 背景音乐设置</h2>
                <div
                    style="background: rgba(93, 213, 255, 0.1); padding: 15px; border-radius: 10px; margin-bottom: 20px;">
                    <p style="margin: 0; font-size: 16px; font-family: 'MapleMono NF CN', sans-serif;">
                        当前背景音乐：<span id="currentBgmName"
                            style="color: #5dd5ff; font-weight: bold; font-family: inherit;">加载中...</span>
                    </p>
                </div>
                <div class="alert" id="bgmAlert"></div>
                <form id="bgmForm">
                    <div class="form-group">
                        <label>音乐名称</label>
                        <input type="text" id="bgmName" placeholder="例如：周杰伦 - 珊瑚海">
                    </div>
                    <div class="form-group">
                        <label>上传音乐文件</label>
                        <div class="file-input-wrapper">
                            <input type="file" id="bgmFile" accept="audio/*">
                            <label for="bgmFile" class="file-input-label">
                                点击选择音乐文件 (支持 mp3, flac, ogg 等格式，最大 200MB)
                            </label>
                        </div>
                        <small style="color: #666; display: block; margin-top: 5px;">
                            提示：如果文件太大，可以使用音频转换工具压缩
                        </small>
                    </div>
                    <button type="submit">更新背景音乐</button>
                </form>
            </div>
            <!-- 个人信息 -->
            <div class="section" id="profileSection">
                <h2>👤 个人信息设置</h2>
                <div class="alert" id="profileAlert"></div>
                <form id="profileForm">
                    <div class="form-group">
                        <label>姓名</label>
                        <input type="text" id="profileName" placeholder="您的名字">
                    </div>
                    <div class="form-group">
                        <label>职业角色</label>
                        <input type="text" id="profileRole" placeholder="例如：Unity个人开发者">
                    </div>
                    <div class="form-group">
                        <label>座右铭</label>
                        <input type="text" id="profileMotto" placeholder="您的座右铭">
                    </div>
                    <div class="form-group">
                        <label>所在地</label>
                        <input type="text" id="profileLocation" placeholder="例如：中国山东">
                    </div>
                    <button type="submit">保存个人信息</button>
                </form>
            </div>

            <!-- 项目管理 -->
            <div class="section" id="projectsSection">
                <h2>📝 发布新项目</h2>
                <div class="alert" id="projectAlert"></div>
                <form id="projectForm">
                    <div class="form-group">
                        <label>项目标题</label>
                        <input type="text" id="projectTitle" required>
                    </div>
                    <div class="form-group">
                        <label>项目分类</label>
                        <select id="projectCategory" required>
                            <option value="">选择分类</option>
                            <option value="技术分享">技术分享</option>
                            <option value="项目心得">项目心得</option>
                            <option value="AI应用">AI应用</option>
                            <option value="游戏开发">游戏开发</option>
                            <option value="个人随笔">个人随笔</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>项目摘要</label>
                        <textarea id="projectExcerpt" placeholder="简短描述项目内容..." required></textarea>
                    </div>
                    <div class="form-group">
                        <label>详细内容 (支持图文混排)</label>
                        <textarea id="projectContent"></textarea>
                    </div>
                    <button type="submit">发布项目</button>
                </form>

                <div class="item-list">
                    <h3>已发布项目</h3>
                    <div id="projectList"></div>
                </div>
            </div>

            <!-- 网站主页管理 -->
            <div class="section" id="sitesSection">
                <h2>🏠 网站主页管理</h2>
                <div class="alert" id="siteAlert"></div>
                <form id="siteForm">
                    <div class="form-group">
                        <label>网站名称</label>
                        <input type="text" id="siteName" placeholder="例如：AI网站" required>
                    </div>
                    <div class="form-group">
                        <label>网站链接</label>
                        <input type="url" id="siteUrl" placeholder="https://example.com" required>
                    </div>
                    <div class="form-group">
                        <label>网站描述</label>
                        <input type="text" id="siteDescription" placeholder="网站功能描述" required>
                    </div>
                    <div class="form-group">
                        <label>网站图标 (emoji)</label>
                        <input type="text" id="siteIcon" placeholder="🌐" maxlength="2" required>
                    </div>
                    <button type="submit">添加网站</button>
                </form>

                <h3 style="margin-top: 30px;">已添加的网站</h3>
                <div class="card-grid" id="sitesList"></div>
            </div>

            <!-- 资源分享管理 -->
            <div class="section" id="resourcesSection">
                <h2>🚀 资源分享管理</h2>
                <div class="alert" id="resourceAlert"></div>
                <form id="resourceForm">
                    <div class="form-group">
                        <label>资源名称</label>
                        <input type="text" id="resourceName" placeholder="例如：Unity插件" required>
                    </div>
                    <div class="form-group">
                        <label>资源链接</label>
                        <input type="url" id="resourceUrl" placeholder="https://example.com/resource" required>
                    </div>
                    <div class="form-group">
                        <label>资源描述</label>
                        <input type="text" id="resourceDescription" placeholder="资源内容描述" required>
                    </div>
                    <div class="form-group">
                        <label>资源图标 (emoji)</label>
                        <input type="text" id="resourceIcon" placeholder="📁" maxlength="2" required>
                    </div>
                    <button type="submit">添加资源</button>
                </form>

                <h3 style="margin-top: 30px;">已添加的资源</h3>
                <div class="card-grid" id="resourcesList"></div>
            </div>

            <!-- 技能管理 -->
            <div class="section" id="skillsSection">
                <h2>⚡ 技能管理</h2>
                <div class="alert" id="skillAlert"></div>
                <form id="skillForm">
                    <div class="form-group">
                        <label>技能名称</label>
                        <input type="text" id="skillName" placeholder="例如：JavaScript" required>
                    </div>
                    <button type="submit">添加技能</button>
                </form>

                <h3 style="margin-top: 30px;">已添加的技能</h3>
                <div class="skills-container" id="skillsList"></div>
            </div>

            <!-- 安全设置 -->
            <div class="section" id="securitySection">
                <h2>🔒 安全设置</h2>

                <div class="alert" id="securityAlert"></div> <!-- [修改] 给这个 alert 一个新ID -->

                <!-- [新增] Turnstile 验证开关 -->
                <h3 style="margin-bottom: 10px;">入口验证模式</h3>
                <div class="form-group" style="background: #f5f7fa; padding: 20px; border-radius: 10px;">
                    <div style="display: flex; align-items: center; justify-content: space-between;">
                        <div>
                            <label for="checkboxInput"
                                style="font-weight: 500; font-size: 16px; color: #333; cursor: pointer;">
                                启用后端强验证 (更安全)
                            </label>
                            <p style="color: #666; font-size: 14px; margin-top: 5px;">
                                开启后，网站入口将使用Secret Key进行验证。
                            </p>
                        </div>
                        <div>
                            <input type="checkbox" id="checkboxInput">
                            <label for="checkboxInput" class="toggleSwitch"></label>
                        </div>
                    </div>
                </div>
                <!-- 分割线 -->
                <hr style="border: none; border-top: 1px solid #e0e0e0; margin: 30px 0;">

                <div class="alert" id="passwordAlert"></div>

                <h3 style="margin-bottom: 20px;">修改登录密码</h3>
                <form id="passwordForm">
                    <div class="form-group">
                        <label>当前密码</label>
                        <input type="password" id="currentPassword" placeholder="请输入当前密码" required>
                    </div>
                    <div class="form-group">
                        <label>新密码</label>
                        <input type="password" id="newPassword" placeholder="请输入新密码（至少6位）" required>
                    </div>
                    <div class="form-group">
                        <label>确认新密码</label>
                        <input type="password" id="confirmPassword" placeholder="请再次输入新密码" required>
                    </div>
                    <button type="submit">修改密码</button>
                </form>

                <div
                    style="margin-top: 30px; padding: 20px; background: rgba(255, 107, 107, 0.1); border-radius: 10px;">
                    <h4 style="color: #ff6b6b; margin-bottom: 10px;">⚠️ 注意事项</h4>
                    <ul style="list-style: none; padding: 0; color: #666;">
                        <li>• 密码至少需要6个字符</li>
                        <li>• 修改密码后需要重新登录</li>
                        <li>• 请妥善保管您的密码</li>
                    </ul>
                </div>
            </div>
            <!-- 评论管理 -->
            <div class="section" id="commentsSection">
                <h2>💬 评论管理</h2>

                <div class="alert" id="commentManagementAlert"></div>

                <div class="tabs" style="margin-bottom: 20px;">
                    <div class="tab active" onclick="showCommentTab('all')">所有评论</div>
                    <div class="tab" onclick="showCommentTab('banned')">IP黑名单</div>
                </div>

                <div id="allCommentsTab">
                    <div id="commentsList"></div>
                </div>

                <h3 style="margin-top: 40px; margin-bottom: 20px; color: #333;">手动封禁IP</h3>
                <form id="manualBanForm" style="display: flex; gap: 15px; align-items: flex-end; margin-bottom: 20px;">
                    <div class="form-group" style="flex: 1; margin-bottom: 0;">
                        <label for="manualBanIp">IP 地址</label>
                        <input type="text" id="manualBanIp" placeholder="例如：192.168.1.1" required>
                    </div>
                    <div class="form-group" style="flex: 2; margin-bottom: 0;">
                        <label for="manualBanReason">封禁原因 (可选)</label>
                        <input type="text" id="manualBanReason" placeholder="例如：发布垃圾评论">
                    </div>
                    <button type="submit" style="width: auto; padding: 12px 24px; margin-bottom: 0;">确认封禁</button>
                </form>

                <div id="bannedIpsTab" style="display: none;">
                    <h3 style="margin-bottom: 20px; color: #333;">已封禁IP列表</h3>
                    <div id="bannedIpsList"></div>
                </div>
            </div>
            <div class="section" id="monitoringSection">
                <h2>🛡️ 安全监控 (可疑访问IP)</h2>
                <div class="alert" id="monitoringAlert"></div>
                <div id="suspiciousIpsList">
                    <p style="text-align: center; opacity: 0.6;">正在加载可疑访问记录...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- 预览模态框 -->
    <div class="preview-modal" id="previewModal">
        <div class="preview-content">
            <div class="preview-header">
                <h3>网站预览</h3>
                <div style="display: flex; align-items: center; gap: 15px;">
                    <button class="refresh-btn" onclick="refreshPreview()">
                        <span style="font-size: 16px;">🔄</span>
                        刷新页面
                    </button>
                    <span class="preview-close" onclick="closePreview()">&times;</span>
                </div>
            </div>
            <iframe class="preview-iframe" id="previewIframe"></iframe>
        </div>
    </div>

    <script>
        const API_BASE = window.location.origin + '/api';
        let authToken = localStorage.getItem('authToken');
        //console.log('页面加载时的token:', authToken);


        // 检查登录状态
        if (authToken) {
            showAdmin();
        }

        // 登录
        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            try {
                const response = await fetch(`${API_BASE}/auth/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json; charset=utf-8' },
                    body: JSON.stringify({
                        username: document.getElementById('username').value,
                        password: document.getElementById('password').value
                    })
                });

                const data = await response.json();

                if (response.ok) {
                    authToken = data.token;
                    localStorage.setItem('authToken', authToken);
                    showAdmin();
                } else {
                    showAlert('loginError', data.message || '登录失败');
                }
            } catch (error) {
                showAlert('loginError', '网络错误，请重试');
            }
        });

        function initializeEditor() {
            tinymce.init({
                selector: '#projectContent', // 绑定到 textarea
                language: 'zh_CN',
                plugins: 'image link lists code media table wordcount',
                toolbar: 'undo redo | blocks | bold italic | alignleft aligncenter alignright | bullist numlist | link image media table | code',
                height: 450,
                menubar: 'file edit view insert format tools table help',

                // 配置图片上传处理
                images_upload_handler: (blobInfo, progress) => new Promise((resolve, reject) => {
                    const formData = new FormData();
                    formData.append('image', blobInfo.blob(), blobInfo.filename());

                    fetch(`${API_BASE}/upload/image`, {
                        method: 'POST',
                        headers: { 'Authorization': `Bearer ${authToken}` },
                        body: formData
                    })
                        .then(response => {
                            if (!response.ok) throw new Error(`HTTP 错误! 状态: ${response.status}`);
                            return response.json();
                        })
                        .then(json => {
                            if (!json || typeof json.imageUrl != 'string') throw new Error('从服务器返回的JSON无效');
                            resolve(json.imageUrl);
                        })
                        .catch(err => {
                            console.error('图片上传失败:', err);
                            showAlert('projectAlert', '图片上传失败: ' + err.message);
                            reject('图片上传失败: ' + err.message);
                        });
                })
            });
        }
        // 显示管理界面
        function showAdmin() {
            document.getElementById('loginContainer').style.display = 'none';
            document.getElementById('adminContainer').style.display = 'block';
            loadAllData();
            // 确保编辑器只被初始化一次
            if (tinymce.get('projectContent')) {
                tinymce.get('projectContent').setContent('');
            } else {
                initializeEditor();
            }
            const turnstileSwitch = document.getElementById('checkboxInput');
            if (turnstileSwitch) {
                // [微调] 为了防止重复绑定，先移除旧的监听器
                const newSwitch = turnstileSwitch.cloneNode(true);
                turnstileSwitch.parentNode.replaceChild(newSwitch, turnstileSwitch);

                newSwitch.addEventListener('change', async function () {
                    const isEnabled = this.checked;
                    const payload = {
                        turnstile_secret_validation_enabled: isEnabled ? 1 : 0
                    };
                    try {
                        const response = await fetch(`${API_BASE}/settings`, {
                            method: 'PUT',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${authToken}`
                            },
                            body: JSON.stringify(payload)
                        });

                        if (response.ok) {
                            showAlert('securityAlert', `后端强验证已${isEnabled ? '开启' : '关闭'}！`, true);
                        } else {
                            showAlert('securityAlert', '设置失败，请重试');
                            this.checked = !isEnabled;
                        }
                    } catch (error) {
                        showAlert('securityAlert', '网络错误，设置失败');
                        this.checked = !isEnabled;
                    }
                });
            }
        }

        // 加载所有数据
        function loadAllData() {
            loadSettings();
            loadProjects();
            loadSites();
            loadResources();
            loadSkills();
            loadComments();
            loadBannedIps();
            loadSuspiciousIps();
        }

        // 监听手动封禁表单的提交事件
        document.getElementById('manualBanForm').addEventListener('submit', async (e) => {
            e.preventDefault(); // 阻止表单默认的刷新页面的行为

            const ipAddress = document.getElementById('manualBanIp').value.trim();
            const reason = document.getElementById('manualBanReason').value.trim() || '手动封禁'; // 如果原因为空，给个默认值

            // 简单的IP地址格式校验
            const ipRegex = /^(?:[0-9]{1,3}\.){3}[0-9]{1,3}$/;
            if (!ipRegex.test(ipAddress)) {
                showAlert('commentManagementAlert', '请输入一个有效的IPv4地址');
                return;
            }

            // 调用已有的 banIP 函数来执行封禁
            // banIP 函数内部会处理 API 调用和后续的界面刷新
            await banIP(ipAddress, reason);

            // 清空输入框
            document.getElementById('manualBanIp').value = '';
            document.getElementById('manualBanReason').value = '';
        });

        // 退出登录
        function logout() {
            localStorage.removeItem('authToken');
            location.reload();
        }

        // 切换选项卡
        function switchTab(tabName) {
            // 更新标签状态
            document.querySelectorAll('.tabs .tab').forEach(tab => { // 限定范围，避免影响子标签
                tab.classList.remove('active');
            });
            // 使用 event.target 可能会因为点击图标而出错，用更稳妥的方式找到主标签
            const mainTabs = document.querySelector('.admin-content > .tabs');
            mainTabs.querySelector(`[onclick="switchTab('${tabName}')"]`).classList.add('active');


            // 显示对应内容
            document.querySelectorAll('.section').forEach(section => {
                section.classList.remove('active');
            });
            document.getElementById(`${tabName}Section`).classList.add('active');
            // 如果切换到的是评论管理页面，则默认激活“所有评论”子标签
            if (tabName === 'comments') {
                showCommentTab('all');
            }
        }

        // 显示提示
        function showAlert(id, message, isSuccess = false) {
            const alert = document.getElementById(id);
            alert.textContent = message;
            alert.className = isSuccess ? 'alert alert-success' : 'alert alert-error';
            alert.style.display = 'block';
            setTimeout(() => alert.style.display = 'none', 3000);
        }

        function refreshPreview() {
            const iframe = document.getElementById('previewIframe');
            iframe.src = iframe.src; // 重新加载
        }

        // 加载设置
        async function loadSettings() {
            try {
                const response = await fetch(`${API_BASE}/settings`);
                const settings = await response.json();

                document.getElementById('profileName').value = settings.profile_name || '';
                document.getElementById('profileRole').value = settings.profile_role || '';
                document.getElementById('profileMotto').value = settings.profile_motto || '';
                document.getElementById('profileLocation').value = settings.profile_location || '';

                const currentBgmName = document.getElementById('currentBgmName');
                if (currentBgmName) {
                    currentBgmName.textContent = settings.bgm_name || '未设置背景音乐';
                }

                const turnstileSwitch = document.getElementById('checkboxInput');
                if (turnstileSwitch) {
                    turnstileSwitch.checked = settings.turnstile_secret_validation_enabled === 1;
                }
            } catch (error) {
                console.error('加载设置失败:', error);
            }
        }
        // 上传背景音乐 - 调试版本
        document.getElementById('bgmForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            // 调试：检查token
            //console.log('当前authToken:', authToken);
            //console.log('localStorage中的token:', localStorage.getItem('authToken'));

            // 如果token不一致，更新它
            if (!authToken && localStorage.getItem('authToken')) {
                authToken = localStorage.getItem('authToken');
                console.log('从localStorage恢复token');
            }

            const formData = new FormData();
            const bgmFile = document.getElementById('bgmFile').files[0];
            const bgmName = document.getElementById('bgmName').value;

            if (!bgmFile) {
                showAlert('bgmAlert', '请选择音乐文件');
                return;
            }

            // 确保token存在
            if (!authToken) {
                showAlert('bgmAlert', '登录已过期，请重新登录');
                console.error('No auth token available');
                // 可选：自动跳转到登录页
                setTimeout(() => logout(), 2000);
                return;
            }

            formData.append('bgm', bgmFile);
            formData.append('bgmName', bgmName || bgmFile.name);

            // 调试：显示请求信息
            console.log('准备上传文件:', {
                fileName: bgmFile.name,
                fileSize: bgmFile.size,
                bgmName: bgmName || bgmFile.name,
                token: authToken.substring(0, 20) + '...' // 只显示部分token
            });

            try {
                const response = await fetch(`${API_BASE}/settings/bgm`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                        // 不要设置 Content-Type，让浏览器自动设置 multipart/form-data
                    },
                    body: formData
                });

                // 调试：显示响应信息
                //console.log('响应状态:', response.status);
                //console.log('响应头:', response.headers);

                const data = await response.json();
                //console.log('响应数据:', data);

                if (response.ok) {
                    showAlert('bgmAlert', `背景音乐更新成功！文件大小：${data.fileSize}`, true);
                    document.getElementById('bgmForm').reset();
                    // 更新当前BGM名称显示
                    const currentBgmName = document.getElementById('currentBgmName');
                    if (currentBgmName) {
                        currentBgmName.textContent = data.bgmName;
                    }
                } else {
                    showAlert('bgmAlert', data.message || '更新失败，请重试');

                    // 如果是token问题，提供更详细的信息
                    if (response.status === 401) {
                        console.error('Token验证失败，可能需要重新登录');
                        console.log('当前token:', authToken);
                    }
                }
            } catch (error) {
                console.error('Upload error:', error);
                showAlert('bgmAlert', '上传失败，请检查网络');
            }
        });
        // 更新个人信息
        document.getElementById('profileForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const data = {
                profile_name: document.getElementById('profileName').value,
                profile_role: document.getElementById('profileRole').value,
                profile_motto: document.getElementById('profileMotto').value,
                profile_location: document.getElementById('profileLocation').value
            };

            try {
                const response = await fetch(`${API_BASE}/settings`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json; charset=utf-8',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify(data)
                });

                if (response.ok) {
                    showAlert('profileAlert', '个人信息更新成功！', true);
                } else {
                    showAlert('profileAlert', '更新失败，请重试');
                }
            } catch (error) {
                showAlert('profileAlert', '保存失败，请检查网络');
            }
        });

        // 发布项目
        document.getElementById('projectForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            // 从 TinyMCE 获取内容，而不是直接从 textarea 获取
            const content = tinymce.get('projectContent').getContent();

            const data = {
                title: document.getElementById('projectTitle').value,
                category: document.getElementById('projectCategory').value,
                excerpt: document.getElementById('projectExcerpt').value,
                content: content // 使用从编辑器获取的HTML内容
            };

            try {
                const response = await fetch(`${API_BASE}/projects`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json; charset=utf-8',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify(data)
                });

                if (response.ok) {
                    showAlert('projectAlert', '项目发布成功！', true);
                    document.getElementById('projectForm').reset();
                    tinymce.get('projectContent').setContent(''); // 清空编辑器
                    loadProjects();
                } else {
                    const errorData = await response.json();
                    showAlert('projectAlert', errorData.message || '发布失败，请重试');
                }
            } catch (error) {
                showAlert('projectAlert', '发布失败，请检查网络');
            }
        });

        // 加载项目列表
        async function loadProjects() {
            try {
                const response = await fetch(`${API_BASE}/projects`);
                const projects = await response.json();

                const list = document.getElementById('projectList');
                list.innerHTML = '';

                projects.forEach(project => {
                    const item = document.createElement('div');
                    item.className = 'list-item';
                    item.innerHTML = `
                        <div class="item-info">
                            <h3>${project.title}</h3>
                            <p>${project.category} - ${new Date(project.created_at).toLocaleDateString()}</p>
                        </div>
                        <div class="item-actions">
                            <button class="btn-delete" onclick="deleteProject(${project.id})">删除</button>
                        </div>
                    `;
                    list.appendChild(item);
                });
            } catch (error) {
                console.error('加载项目失败:', error);
            }
        }

        // 删除项目
        async function deleteProject(id) {
            if (!confirm('确定要删除这个项目吗？')) return;

            try {
                const response = await fetch(`${API_BASE}/projects/${id}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });

                if (response.ok) {
                    loadProjects();
                    loadComments();
                    showAlert('projectAlert', '项目及关联评论已删除！', true);
                }
            } catch (error) {
                alert('删除失败，请重试');
            }
        }

        // 添加网站
        document.getElementById('siteForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const data = {
                name: document.getElementById('siteName').value,
                url: document.getElementById('siteUrl').value,
                description: document.getElementById('siteDescription').value,
                icon: document.getElementById('siteIcon').value
            };

            try {
                const response = await fetch(`${API_BASE}/sites`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json; charset=utf-8',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify(data)
                });

                if (response.ok) {
                    showAlert('siteAlert', '网站添加成功！', true);
                    document.getElementById('siteForm').reset();
                    loadSites();
                } else {
                    showAlert('siteAlert', '添加失败，请重试');
                }
            } catch (error) {
                showAlert('siteAlert', '网络错误，请稍后重试');
            }
        });

        // 加载网站列表
        async function loadSites() {
            try {
                const response = await fetch(`${API_BASE}/sites`);
                const sites = await response.json();

                const list = document.getElementById('sitesList');
                list.innerHTML = '';

                sites.forEach(site => {
                    const card = document.createElement('div');
                    card.className = 'card-item';
                    card.innerHTML = `
                        <div class="card-actions">
                            <button class="btn-delete-small" onclick="deleteSite(${site.id})">删除</button>
                        </div>
                        <div class="card-icon">${site.icon}</div>
                        <h3>${site.name}</h3>
                        <p>${site.description}</p>
                        <a href="${site.url}" target="_blank" style="color: #667eea;">访问网站</a>
                    `;
                    list.appendChild(card);
                });
            } catch (error) {
                console.error('加载网站失败:', error);
            }
        }

        // 删除网站
        async function deleteSite(id) {
            if (!confirm('确定要删除这个网站吗？')) return;

            try {
                const response = await fetch(`${API_BASE}/sites/${id}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });

                if (response.ok) {
                    loadSites();
                }
            } catch (error) {
                alert('删除失败，请重试');
            }
        }

        // 添加资源
        document.getElementById('resourceForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const data = {
                name: document.getElementById('resourceName').value,
                url: document.getElementById('resourceUrl').value,
                description: document.getElementById('resourceDescription').value,
                icon: document.getElementById('resourceIcon').value
            };

            try {
                const response = await fetch(`${API_BASE}/resources`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json; charset=utf-8',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify(data)
                });

                if (response.ok) {
                    showAlert('resourceAlert', '资源添加成功！', true);
                    document.getElementById('resourceForm').reset();
                    loadResources();
                } else {
                    showAlert('resourceAlert', '添加失败，请重试');
                }
            } catch (error) {
                showAlert('resourceAlert', '网络错误，请稍后重试');
            }
        });

        // 加载资源列表
        async function loadResources() {
            try {
                const response = await fetch(`${API_BASE}/resources`);
                const resources = await response.json();

                const list = document.getElementById('resourcesList');
                list.innerHTML = '';

                resources.forEach(resource => {
                    const card = document.createElement('div');
                    card.className = 'card-item';
                    card.innerHTML = `
                        <div class="card-actions">
                            <button class="btn-delete-small" onclick="deleteResource(${resource.id})">删除</button>
                        </div>
                        <div class="card-icon">${resource.icon}</div>
                        <h3>${resource.name}</h3>
                        <p>${resource.description}</p>
                        <a href="${resource.url}" target="_blank" style="color: #667eea;">查看资源</a>
                    `;
                    list.appendChild(card);
                });
            } catch (error) {
                console.error('加载资源失败:', error);
            }
        }

        // 删除资源
        async function deleteResource(id) {
            if (!confirm('确定要删除这个资源吗？')) return;

            try {
                const response = await fetch(`${API_BASE}/resources/${id}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });

                if (response.ok) {
                    loadResources();
                }
            } catch (error) {
                alert('删除失败，请重试');
            }
        }

        // 添加技能
        document.getElementById('skillForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const data = {
                name: document.getElementById('skillName').value
            };

            try {
                const response = await fetch(`${API_BASE}/skills`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json; charset=utf-8',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify(data)
                });

                if (response.ok) {
                    showAlert('skillAlert', '技能添加成功！', true);
                    document.getElementById('skillForm').reset();
                    loadSkills();
                } else {
                    showAlert('skillAlert', '添加失败，请重试');
                }
            } catch (error) {
                showAlert('skillAlert', '网络错误，请稍后重试');
            }
        });

        // 加载技能列表
        async function loadSkills() {
            try {
                const response = await fetch(`${API_BASE}/skills`);
                const skills = await response.json();

                const list = document.getElementById('skillsList');
                list.innerHTML = '';

                skills.forEach(skill => {
                    const tag = document.createElement('div');
                    tag.className = 'skill-tag';
                    tag.innerHTML = `
                        ${skill.name}
                        <span class="delete-skill" onclick="deleteSkill(${skill.id})">×</span>
                    `;
                    list.appendChild(tag);
                });
            } catch (error) {
                console.error('加载技能失败:', error);
            }
        }

        // 删除技能
        async function deleteSkill(id) {
            if (!confirm('确定要删除这个技能吗？')) return;

            try {
                const response = await fetch(`${API_BASE}/skills/${id}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });

                if (response.ok) {
                    loadSkills();
                }
            } catch (error) {
                alert('删除失败，请重试');
            }
        }

        // 修改密码
        document.getElementById('passwordForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const currentPassword = document.getElementById('currentPassword').value;
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;

            // 验证新密码
            if (newPassword !== confirmPassword) {
                showAlert('passwordAlert', '两次输入的新密码不一致');
                return;
            }

            if (newPassword.length < 6) {
                showAlert('passwordAlert', '新密码至少需要6个字符');
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/auth/change-password`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json; charset=utf-8',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({
                        currentPassword,
                        newPassword
                    })
                });

                const data = await response.json();

                if (response.ok) {
                    showAlert('passwordAlert', '密码修改成功！3秒后将跳转到登录页面...', true);
                    document.getElementById('passwordForm').reset();

                    // 3秒后退出登录
                    setTimeout(() => {
                        logout();
                    }, 3000);
                } else {
                    showAlert('passwordAlert', data.message || '密码修改失败');
                }
            } catch (error) {
                showAlert('passwordAlert', '网络错误，请稍后重试');
            }
        });

        // 打开预览
        function openPreview() {
            const modal = document.getElementById('previewModal');
            const iframe = document.getElementById('previewIframe');
            iframe.src = '/blogs.html';
            modal.style.display = 'block';
        }

        // 关闭预览
        function closePreview() {
            document.getElementById('previewModal').style.display = 'none';
            document.getElementById('previewIframe').src = '';
        }

        // 点击模态框外部关闭
        document.getElementById('previewModal').addEventListener('click', function (e) {
            if (e.target === this) {
                closePreview();
            }
        });
        // 评论标签切换
        function showCommentTab(tab) {
            if (tab === 'all') {
                document.getElementById('allCommentsTab').style.display = 'block';
                document.getElementById('bannedIpsTab').style.display = 'none';
            } else {
                document.getElementById('allCommentsTab').style.display = 'none';
                document.getElementById('bannedIpsTab').style.display = 'block';
            }

            // 更新标签状态
            const tabs = document.querySelectorAll('#commentsSection .tabs .tab');
            tabs.forEach((t, index) => {
                t.classList.toggle('active', (tab === 'all' && index === 0) || (tab === 'banned' && index === 1));
            });
        }

        // 加载评论列表
        async function loadComments() {
            try {
                const response = await fetch(`${API_BASE}/admin/comments`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                const comments = await response.json();

                const list = document.getElementById('commentsList');

                if (comments.length === 0) {
                    list.innerHTML = '<p style="text-align: center; opacity: 0.6;">暂无评论</p>';
                    return;
                }

                list.innerHTML = comments.map(comment => `
            <div class="list-item" style="flex-direction: column; align-items: stretch;">
                <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                    <div>
                        <strong>${comment.nickname}</strong> 
                        ${comment.email ? `(${comment.email})` : ''}
                        <span style="color: #ff6b6b; margin-left: 10px;">IP: ${comment.ip_address}</span>
                    </div>
                    <div class="item-actions">
                        <button class="btn-delete" onclick="deleteComment(${comment.id})">删除</button>
                        <button class="btn-edit" style="background: #ff6b6b;" onclick="banIP('${comment.ip_address}')">封禁IP</button>
                    </div>
                </div>
                <div style="color: #666; font-size: 14px; margin-bottom: 5px;">
                    项目：${comment.project_title} | 时间：${new Date(comment.created_at).toLocaleString('zh-CN')}
                </div>
                <div style="background: #f5f7fa; padding: 10px; border-radius: 5px;">
                    ${comment.content}
                </div>
            </div>
        `).join('');
            } catch (error) {
                console.error('加载评论失败:', error);
            }
        }

        // 删除评论
        async function deleteComment(id) {
            if (!confirm('确定要删除这条评论吗？')) return;

            try {
                const response = await fetch(`${API_BASE}/admin/comments/${id}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });

                if (response.ok) {
                    showAlert('commentManagementAlert', '删除成功', true);
                    loadComments();
                }
            } catch (error) {
                showAlert('commentManagementAlert', '删除失败');
            }
        }

        // 封禁IP
        async function banIP(ip, reason) { // <--- 修正1: 接收 reason 参数
            // 如果 reason 未提供或为空，则设置一个默认值
            const banReason = reason || '违规操作';

            if (!confirm(`确定要封禁IP: ${ip} 吗？\n原因: ${banReason}`)) return;

            try {
                const response = await fetch(`${API_BASE}/admin/ban-ip`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    // 修正2: 发送给后端的键应该是 reason
                    body: JSON.stringify({ ip_address: ip, reason: banReason })
                });

                const data = await response.json();

                if (response.ok) {
                    showAlert('commentManagementAlert', data.message || 'IP封禁成功', true);
                    loadComments();
                    loadBannedIps();
                    // 封禁成功后，也应该刷新可疑IP列表
                    loadSuspiciousIps();
                } else {
                    showAlert('commentManagementAlert', data.message || 'IP封禁失败');
                }
            } catch (error) {
                showAlert('commentManagementAlert', '网络错误，IP封禁失败');
            }
        }

        // 加载封禁IP列表
        async function loadBannedIps() {
            try {
                const response = await fetch(`${API_BASE}/admin/banned-ips`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                const ips = await response.json();

                const list = document.getElementById('bannedIpsList');

                if (ips.length === 0) {
                    list.innerHTML = '<p style="text-align: center; opacity: 0.6;">暂无封禁IP</p>';
                    return;
                }

                list.innerHTML = ips.map(ip => `
            <div class="list-item">
                <div class="item-info">
                    <h3>${ip.ip_address}</h3>
                    <p>原因：${ip.reason || '未说明'} | 封禁时间：${new Date(ip.banned_at).toLocaleString('zh-CN')}</p>
                </div>
                <div class="item-actions">
                    <button class="btn-edit" onclick="unbanIP('${ip.ip_address}')">解除封禁</button>
                </div>
            </div>
        `).join('');
            } catch (error) {
                console.error('加载封禁列表失败:', error);
            }
        }

        // 解除封禁
        async function unbanIP(ip) {
            if (!confirm('确定要解除该IP的封禁吗？')) return;

            try {
                const response = await fetch(`${API_BASE}/admin/banned-ips/${encodeURIComponent(ip)}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });

                if (response.ok) {
                    showAlert('commentManagementAlert', '解除封禁成功', true);
                    loadBannedIps();
                }
            } catch (error) {
                showAlert('commentManagementAlert', '解除封禁失败');
            }
        }

        // 加载可疑IP列表的函数
        async function loadSuspiciousIps() {
            try {
                const response = await fetch(`${API_BASE}/admin/suspicious-ips`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                const ips = await response.json();

                const list = document.getElementById('suspiciousIpsList');
                if (ips.length === 0) {
                    list.innerHTML = '<p style="text-align: center; opacity: 0.6;">太棒了！目前没有发现可疑访问。</p>';
                    return;
                }

                list.innerHTML = ips.map(ip => `
            <div class="list-item">
                <div class="item-info">
                    <h3>IP: ${ip.ip_address}</h3>
                    <p>原因: ${ip.reason} | 触发次数: ${ip.hit_count}</p>
                    <p>最后发现时间: ${new Date(ip.last_seen).toLocaleString('zh-CN')}</p>
                </div>
                <div class="item-actions">
                    <button class="btn-delete" onclick="banSuspiciousIP('${ip.ip_address}', '${ip.reason}')">封禁</button>
                    <button class="btn-edit" style="background: #777;" onclick="ignoreSuspiciousIP(${ip.id})">忽略</button>
                </div>
            </div>
        `).join('');
            } catch (error) {
                console.error('加载可疑IP失败:', error);
            }
        }

        // 封禁可疑IP (调用已有的 banIP 函数)
        function banSuspiciousIP(ip, reason) {
            if (confirm(`确定要封禁IP: ${ip} 吗？`)) {
                // 复用已有的 banIP 函数，让它能从这个新界面调用
                banIP(ip, reason);
            }
        }

        // 忽略可疑IP
        async function ignoreSuspiciousIP(id) {
            try {
                const response = await fetch(`${API_BASE}/admin/suspicious-ips/${id}/ignore`, {
                    method: 'PUT',
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                if (response.ok) {
                    showAlert('monitoringAlert', '已忽略该IP', true);
                    loadSuspiciousIps(); // 重新加载列表
                } else {
                    showAlert('monitoringAlert', '操作失败');
                }
            } catch (error) {
                showAlert('monitoringAlert', '网络错误');
            }
        }
    </script>
</body>

</html>